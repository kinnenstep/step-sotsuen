<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STEP卒煙 - リアルタイムSNS</title>
    
    <!-- ベースのSVGアイコン -->
    <link rel="icon" type="image/svg+xml" id="favicon-svg" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%236fdc8c'/%3E%3Cpath d='M100 300 L70 300 Q60 300 60 340 L60 380' stroke='%23ef4444' stroke-width='30' fill='none' stroke-linecap='round'/%3E%3Cpath d='M412 300 L442 300 Q452 300 452 260 L452 200' stroke='%23ef4444' stroke-width='30' fill='none' stroke-linecap='round'/%3E%3Cpath d='M180 400 L180 450 L140 450' stroke='%23ef4444' stroke-width='30' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M332 400 L332 450 L372 450' stroke='%23ef4444' stroke-width='30' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='256' cy='256' r='140' stroke='%23ef4444' stroke-width='45' fill='none'/%3E%3Cline x1='160' y1='160' x2='352' y2='352' stroke='%23ef4444' stroke-width='45' stroke-linecap='round'/%3E%3Crect x='170' y='236' width='172' height='40' fill='white'/%3E%3Cline x1='300' y1='236' x2='300' y2='276' stroke='%23ccc' stroke-width='2'/%3E%3Cline x1='315' y1='236' x2='315' y2='276' stroke='%23ccc' stroke-width='2'/%3E%3C/svg%3E">
    
    <!-- PWA用マニフェスト -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"STEP卒煙","short_name":"STEP卒煙","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 rx=%27100%27 fill=%27%236fdc8c%27/%3E%3Cpath d=%27M100 300 L70 300 Q60 300 60 340 L60 380%27 stroke=%27%23ef4444%27 stroke-width=%2730%27 fill=%27none%27 stroke-linecap=%27round%27/%3E%3Cpath d=%27M412 300 L442 300 Q452 300 452 260 L452 200%27 stroke=%27%23ef4444%27 stroke-width=%2730%27 fill=%27none%27 stroke-linecap=%27round%27/%3E%3Cpath d=%27M180 400 L180 450 L140 450%27 stroke=%27%23ef4444%27 stroke-width=%2730%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3Cpath d=%27M332 400 L332 450 L372 450%27 stroke=%27%23ef4444%27 stroke-width=%2730%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3Ccircle cx=%27256%27 cy=%27256%27 r=%27140%27 stroke=%27%23ef4444%27 stroke-width=%2745%27 fill=%27none%27/%3E%3Cline x1=%27160%27 y1=%27160%27 x2=%27352%27 y2=%27352%27 stroke=%27%23ef4444%27 stroke-width=%2745%27 stroke-linecap=%27round%27/%3E%3Crect x=%27170%27 y=%27236%27 width=%27172%27 height=%2740%27 fill=%27white%27/%3E%3Cline x1=%27300%27 y1=%27236%27 x2=%27300%27 y2=%27276%27 stroke=%27%23ccc%27 stroke-width=%272%27/%3E%3Cline x1=%27315%27 y1=%27236%27 x2=%27315%27 y2=%27276%27 stroke=%27%23ccc%27 stroke-width=%272%27/%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-emerald: #10b981;
            --brand-bg: #ffffff;
            --twitter-border: #eff3f4;
        }
        body {
            background-color: var(--brand-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #0f1419;
            overflow: hidden;
            height: 100vh;
            height: 100dvh; /* Android対策 */
            margin: 0;
        }

        .app-container {
            height: 100vh;
            height: 100dvh;
            display: none;
            flex-direction: column;
            position: relative;
        }
        .app-container.active {
            display: flex;
        }

        .scrollable {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .bottom-nav {
            height: 64px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--twitter-border);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            flex-shrink: 0;
        }

        .post-button {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 9999px;
            background-color: var(--brand-emerald);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
            z-index: 140;
            border: none;
            cursor: pointer;
        }

        #toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 999px;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 14px;
            pointer-events: none;
        }
        #toast.show { 
            opacity: 1;
            transform: translateX(-50%) translateY(0); 
        }

        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
        }

        #auth-gateway {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc;
            z-index: 900;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        #thread-overlay { z-index: 500; }
        #profile-overlay { z-index: 600; }
        #modal-overlay { z-index: 700; }

        .overlay-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            cursor: pointer;
            height: 100vh;
            height: 100dvh;
        }
        .overlay-container.active { display: block; }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .demo-badge {
            background: #fee2e2;
            color: #ef4444;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            vertical-align: middle;
        }

        .notif-badge {
            position: absolute;
            top: 10px;
            right: calc(50% - 18px);
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            display: none;
        }
        .notif-badge.active {
            display: block;
        }

        #profile-inner-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 2.5rem 2.5rem 0 0;
            height: 90vh;
            height: 90dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: default;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="text-emerald-500 text-4xl mb-4"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
        <div class="font-bold text-gray-400">接続中...</div>
    </div>

    <div id="auth-gateway">
        <div class="w-full max-w-sm bg-white p-8 rounded-[2.5rem] shadow-xl text-center">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6">
                <i class="fa-solid fa-leaf"></i>
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-2">STEP卒煙</h2>
            <p class="text-gray-500 text-sm mb-8">仲間と一緒に、新しい自分へ。</p>
            
            <div id="auth-form" class="hidden space-y-3 mb-4">
                <input type="email" id="auth-email" placeholder="メールアドレス" class="w-full bg-gray-50 p-4 rounded-2xl border-none outline-none text-sm">
                <input type="password" id="auth-password" placeholder="パスワード" class="w-full bg-gray-50 p-4 rounded-2xl border-none outline-none text-sm">
                <button id="btn-execute-auth" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg">
                    <span id="auth-action-text">ログイン</span>
                </button>
                <button id="btn-toggle-auth" class="text-xs text-emerald-600 font-bold">アカウントを新規作成する</button>
                <div class="border-t border-gray-100 my-4 pt-4">
                    <button id="btn-back-to-gateway" class="text-xs text-gray-400 font-bold">戻る</button>
                </div>
            </div>

            <div id="gateway-buttons" class="space-y-3">
                <button id="btn-show-login" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg">
                    ログイン / 会員登録
                </button>
                <button id="btn-guest-login" class="w-full border-2 border-gray-100 bg-white text-gray-500 font-bold py-4 rounded-2xl hover:bg-gray-50 transition">
                    ゲストとして利用
                </button>
            </div>
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-6">
                ゲストは閲覧のみ可能です。
            </p>
        </div>
    </div>

    <div id="toast">完了しました</div>

    <div id="app-root" class="app-container">
        <header class="bg-white border-b border-gray-100 h-14 shrink-0 relative flex items-center justify-between px-4 z-20">
            <div class="w-16"></div>
            <div id="header-logo-area" class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center cursor-pointer active:scale-95 transition-transform">
                <h1 class="text-xl font-black text-emerald-600 flex items-center gap-1">
                    <i class="fa-solid fa-leaf text-lg"></i> STEP卒煙
                </h1>
                <span id="demo-mode-indicator" class="demo-badge hidden mt-0.5">デモモード</span>
            </div>
            <div id="user-rank-badge" class="text-[11px] font-bold bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full border border-emerald-100 max-w-[120px] truncate text-center">
                卒煙ビギナー
            </div>
        </header>

        <!-- View: Home -->
        <div id="view-home" class="view-content scrollable">
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 m-4 p-6 rounded-[2.5rem] text-white shadow-xl">
                <div class="text-3xl font-black mb-4 leading-tight" id="stat-days">卒煙歴0日</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/20 p-3 rounded-2xl">
                        <div class="text-[10px] font-black uppercase tracking-widest mb-1">節約金額</div>
                        <div class="text-lg font-bold" id="stat-money">¥0</div>
                    </div>
                    <div class="bg-white/20 p-3 rounded-2xl">
                        <div class="text-[10px] font-black uppercase tracking-widest mb-1">回避本数</div>
                        <div class="text-lg font-bold" id="stat-sticks">0本</div>
                    </div>
                </div>
            </div>
            <div id="home-posts" class="divide-y divide-gray-50 pb-24"></div>
        </div>

        <!-- View: Notif -->
        <div id="view-notif" class="view-content scrollable hidden">
            <div class="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <h3 class="font-bold text-sm text-gray-500">お知らせ</h3>
                <button id="btn-clear-notif" class="text-[10px] font-bold text-red-400 border border-red-100 px-2 py-1 rounded-lg">すべて削除</button>
            </div>
            <div id="notif-list" class="divide-y divide-gray-50">
                <div class="p-10 text-center text-gray-300 font-bold">通知はありません</div>
            </div>
        </div>

        <!-- View: Setting -->
        <div id="view-setting" class="view-content scrollable hidden p-4 pb-24">
            <h2 class="text-lg font-bold mb-6 text-gray-800">設定</h2>
            
            <div class="flex flex-col items-center mb-6">
                <div id="cfg-avatar-display" class="w-24 h-24 bg-gray-100 rounded-3xl overflow-hidden flex items-center justify-center text-3xl text-gray-400 mb-2 border-2 border-emerald-500">
                    <i class="fa-solid fa-user"></i>
                </div>
                <label class="text-emerald-600 font-bold text-sm cursor-pointer">
                    アイコンを変更
                    <input type="file" id="cfg-avatar-input" accept="image/*" class="hidden">
                </label>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-2">名前</label>
                    <input type="text" id="cfg-name" placeholder="ユーザー名" class="w-full bg-gray-50 p-4 rounded-xl font-bold border-none outline-none mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-2">自己紹介</label>
                    <textarea id="cfg-bio" placeholder="自己紹介" class="w-full bg-gray-50 p-4 rounded-xl font-medium border-none outline-none h-24 mt-1"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-2">禁煙開始日時</label>
                    <input type="datetime-local" id="cfg-date" class="w-full bg-gray-50 p-4 rounded-xl font-bold border-none outline-none mt-1">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-400 ml-2">1日の本数</label>
                        <input type="number" id="cfg-sticks" placeholder="本数" class="w-full bg-gray-50 p-4 rounded-xl border-none outline-none mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 ml-2">1箱の値段</label>
                        <input type="number" id="cfg-price" placeholder="値段" class="w-full bg-gray-50 p-4 rounded-xl border-none outline-none mt-1">
                    </div>
                </div>
                
                <button id="btn-save-settings" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg mt-4">設定を保存</button>

                <!-- Block Management Section -->
                <div class="mt-8">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 px-2">ブロック中のユーザー</h3>
                    <div id="block-list" class="bg-gray-50 rounded-2xl p-4 divide-y divide-gray-200">
                        <p class="text-xs text-center text-gray-400 py-2">ブロックしているユーザーはいません</p>
                    </div>
                </div>
                
                <div class="pt-10 space-y-2">
                    <button id="btn-logout" class="w-full py-4 text-gray-500 font-bold border border-gray-200 rounded-2xl hover:bg-gray-50">ログアウト</button>
                    <button id="btn-delete-account" class="w-full py-4 text-red-400 font-bold text-xs hover:underline">アカウントを完全に削除する</button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <button data-view="home" class="nav-btn flex-1 flex flex-col items-center text-emerald-600 relative">
                <i class="fa-solid fa-house"></i><span class="text-[10px] mt-1 font-bold">ホーム</span>
            </button>
            <button data-view="notif" class="nav-btn flex-1 flex flex-col items-center text-gray-400 relative">
                <i class="fa-solid fa-bell"></i><span class="text-[10px] mt-1 font-bold">通知</span>
                <div id="notif-red-dot" class="notif-badge"></div>
            </button>
            <button data-view="setting" class="nav-btn flex-1 flex flex-col items-center text-gray-400 relative">
                <i class="fa-solid fa-user-gear"></i><span class="text-[10px] mt-1 font-bold">設定</span>
            </button>
        </nav>

        <button id="fab" class="post-button"><i class="fa-solid fa-plus text-2xl"></i></button>
    </div>

    <!-- Modals & Overlays -->
    <div id="modal-overlay" class="overlay-container">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 h-[70vh] flex flex-col cursor-default" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <button id="btn-close-modal" class="text-gray-400 font-bold">閉じる</button>
                <div id="reply-target-info" class="text-xs font-bold text-emerald-600 hidden">返信先: <span></span></div>
                <button id="btn-submit-post" class="bg-emerald-600 text-white px-6 py-2 rounded-full font-bold">送信</button>
            </div>
            <textarea id="modal-textarea" class="flex-1 w-full text-lg border-none focus:ring-0 resize-none" placeholder="今の気持ちは？"></textarea>
        </div>
    </div>

    <div id="thread-overlay" class="overlay-container">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-0 h-[90vh] flex flex-col overflow-hidden cursor-default" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <button id="btn-close-thread" class="text-gray-400 font-bold">閉じる</button>
                <h3 class="font-bold">スレッド</h3>
                <div class="w-10"></div>
            </div>
            <div id="thread-content" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        </div>
    </div>

    <div id="profile-overlay" class="overlay-container">
        <div id="profile-inner-container" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center shrink-0">
                <button id="btn-close-profile" class="text-gray-400 font-bold">閉じる</button>
                <h3 class="font-bold text-sm">プロフィール</h3>
                <div class="w-10"></div>
            </div>
            <div class="scrollable">
                <div class="p-8 flex flex-col items-center text-center">
                    <div id="prof-avatar" class="w-24 h-24 bg-emerald-100 rounded-3xl mb-4 overflow-hidden flex items-center justify-center text-3xl font-bold text-emerald-600"></div>
                    <h2 id="prof-name" class="text-2xl font-black text-gray-800"></h2>
                    <div id="prof-smoke-history" class="text-emerald-600 font-bold text-sm mb-4 bg-emerald-50 px-4 py-1 rounded-full"></div>
                    <p id="prof-bio" class="text-gray-500 text-sm leading-relaxed max-w-xs mb-6"></p>
                    
                    <div id="profile-actions" class="w-full max-w-xs mb-8">
                        <button id="btn-block-user" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-2xl flex items-center justify-center gap-2">
                            <i class="fa-solid fa-ban"></i> このユーザーをブロック
                        </button>
                    </div>

                    <div class="w-full text-left">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 border-b pb-2">この人の投稿</h4>
                        <div id="prof-posts" class="divide-y divide-gray-50"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteUser, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, updateDoc, arrayUnion, arrayRemove, deleteDoc, writeBatch, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'step-sotsuen-default';
        const firebaseConfig = {
            apiKey: "AIzaSyBk0fqca2a1xfmZsCLK_zJLSWsp8WV8UVk",
            authDomain: "step-sotsuen.firebaseapp.com",
            projectId: "step-sotsuen",
            storageBucket: "step-sotsuen.firebasestorage.app",
            messagingSenderId: "407444481880",
            appId: "1:407444481880:web:d1b0176dfe20e7a3efa72d",
            measurementId: "G-BG30SB69RR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            user: null,
            isDemo: false,
            authMode: 'login',
            userData: { name: "ゲスト", bio: "デモモードで閲覧中", date: new Date().toISOString(), sticks: 20, price: 600, avatar: null, blocks: [] },
            posts: [],
            notifications: [],
            replyTarget: null,
            currentThreadRootId: null,
            currentViewUid: null,
            editingAvatar: null // 設定変更中の一時保存
        };

        let statsTimer = null;

        // iOS等の「ホーム画面に追加」用に、SVGアイコンをPNGに変換して apple-touch-icon を生成する
        const setupAppleTouchIcon = () => {
            const svgUrl = document.getElementById('favicon-svg').href;
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const pngData = canvas.toDataURL('image/png');
                
                let link = document.querySelector('link[rel="apple-touch-icon"]');
                if (!link) {
                    link = document.createElement('link');
                    link.rel = 'apple-touch-icon';
                    document.head.appendChild(link);
                }
                link.href = pngData;
            };
            img.src = svgUrl;
        };
        // 起動時に実行
        setupAppleTouchIcon();


        // UTC文字列をローカル日時のYYYY-MM-DDThh:mm形式に変換（設定画面の時間ズレ防止）
        const toDatetimeLocal = (isoString) => {
            if (!isoString) return '';
            const d = new Date(isoString);
            const offset = d.getTimezoneOffset() * 60000; 
            // ローカルオフセット分を引いてISOString化し、Z以前を取得
            return (new Date(d - offset)).toISOString().slice(0, 16);
        };

        const showToast = (m) => {
            const t = document.getElementById('toast');
            if(!t) return;
            t.innerText = m; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        const toggleUI = (view) => {
            document.getElementById('loading-screen').style.display = view === 'loading' ? 'flex' : 'none';
            document.getElementById('auth-gateway').style.display = view === 'auth' ? 'flex' : 'none';
            document.getElementById('app-root').classList.toggle('active', view === 'app');
        };

        const getSmokeHistory = (startDate) => {
            const now = new Date();
            const start = new Date(startDate);
            const diffMs = now - start;
            if (diffMs < 0) return "卒煙準備中";
            const diffDay = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDay < 100) return `卒煙歴${diffDay}日`;
            const diffMonth = Math.floor(diffDay / 30.44);
            if (diffMonth < 12) return `卒煙歴${diffMonth}ヶ月`;
            return `卒煙歴${Math.floor(diffDay / 365.25)}年`;
        };

        const getFullStatsText = (startDate) => {
            const now = new Date();
            const start = new Date(startDate);
            const diffMs = now - start;
            if (diffMs < 0) return "卒煙準備中";
            const diffSecTotal = Math.floor(diffMs / 1000);
            const diffMinTotal = Math.floor(diffSecTotal / 60);
            const diffHourTotal = Math.floor(diffMinTotal / 60);
            const diffDay = Math.floor(diffHourTotal / 24);
            const hours = diffHourTotal % 24;
            const mins = diffMinTotal % 60;
            const secs = diffSecTotal % 60;
            let label = (diffDay < 100) ? `${diffDay}日` : (Math.floor(diffDay/30.44) < 12) ? `${Math.floor(diffDay/30.44)}ヶ月` : `${Math.floor(diffDay/365.25)}年`;
            return `卒煙歴${label}<br><span class="text-sm font-normal opacity-80">${diffDay}日 ${hours}時 ${mins}分 ${secs}秒</span>`;
        };

        // --- AUTH ---
        const initAuthFlow = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) { await signInAnonymously(auth); }
            }
        };
        initAuthFlow();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                state.isDemo = user.isAnonymous;
                await setupApp();
            } else {
                toggleUI('auth');
            }
        });

        const setupApp = async () => {
            toggleUI('loading');
            const uid = state.user.uid;
            
            if (!state.isDemo) {
                onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'settings', 'profile'), (snap) => {
                    if (snap.exists()) {
                        state.userData = { ...state.userData, blocks: [], ...snap.data() };
                        syncSettingsUI();
                        updateStats();
                        renderHomePosts(); 
                    }
                });
                
                onSnapshot(query(collection(db, 'artifacts', appId, 'users', uid, 'notifications')), (snap) => {
                    state.notifications = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(b.date) - new Date(a.date));
                    renderNotifications();
                    document.getElementById('notif-red-dot').classList.toggle('active', state.notifications.length > 0);
                });
            } else {
                syncSettingsUI();
                updateStats();
            }

            const postsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), orderBy('date', 'desc'));
            onSnapshot(postsQuery, (snap) => {
                state.posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHomePosts();
                if (state.currentThreadRootId) renderThread(state.currentThreadRootId);
                if (state.currentViewUid) renderProfilePosts(state.currentViewUid);
            });

            toggleUI('app');
            startStatsTimer();
        };

        const updateStats = () => {
            const now = new Date();
            const start = new Date(state.userData.date);
            const diffMs = now - start;
            if (diffMs < 0) return;
            const diffDay = diffMs / (1000 * 60 * 60 * 24);
            const savedMoney = Math.floor(diffDay * (state.userData.sticks / 20) * state.userData.price);
            const avoidedSticks = Math.floor(diffDay * state.userData.sticks);
            
            document.getElementById('stat-days').innerHTML = getFullStatsText(state.userData.date);
            document.getElementById('stat-money').innerText = `¥${savedMoney.toLocaleString()}`;
            document.getElementById('stat-sticks').innerText = `${avoidedSticks.toLocaleString()}本`;
        };

        const startStatsTimer = () => {
            if (statsTimer) clearInterval(statsTimer);
            statsTimer = setInterval(updateStats, 1000);
        };

        const syncSettingsUI = async () => {
            // 編集中でなければフォームをDBの値で更新
            if (state.editingAvatar === null) {
                const display = document.getElementById('cfg-avatar-display');
                display.innerHTML = state.userData.avatar ? `<img src="${state.userData.avatar}" class="avatar-img">` : `<i class="fa-solid fa-user"></i>`;
            }
            
            document.getElementById('cfg-name').value = state.userData.name;
            document.getElementById('cfg-bio').value = state.userData.bio;
            // ローカル時間に変換してセット（ここが修正点）
            document.getElementById('cfg-date').value = toDatetimeLocal(state.userData.date);
            document.getElementById('cfg-sticks').value = state.userData.sticks;
            document.getElementById('cfg-price').value = state.userData.price;
            document.getElementById('demo-mode-indicator').classList.toggle('hidden', !state.isDemo);

            const blContainer = document.getElementById('block-list');
            if (!state.userData.blocks || state.userData.blocks.length === 0) {
                blContainer.innerHTML = '<p class="text-xs text-center text-gray-400 py-2">ブロックしているユーザーはいません</p>';
            } else {
                let html = '';
                for (const bUid of state.userData.blocks) {
                    const post = state.posts.find(p => p.uid === bUid);
                    const name = post ? post.userName : 'Unknown';
                    html += `
                        <div class="flex justify-between items-center py-2">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-gray-600">${name}</span>
                                <span class="text-[8px] text-gray-400">${bUid}</span>
                            </div>
                            <button onclick="window.unblockUser('${bUid}')" class="text-[10px] bg-white border border-gray-200 px-3 py-1 rounded-full text-gray-500 font-bold">解除</button>
                        </div>
                    `;
                }
                blContainer.innerHTML = html;
            }
        };

        // --- RENDERING ---
        const renderPost = (post, isThreadMain = false) => {
            if (state.userData.blocks?.includes(post.uid)) return '';

            const history = getSmokeHistory(post.userDate || new Date().toISOString());
            const avatarHtml = post.userAvatar ? `<img src="${post.userAvatar}" class="avatar-img">` : `<i class="fa-solid fa-user"></i>`;
            const isMyPost = state.user && !state.isDemo && state.user.uid === post.uid;
            
            const deleteBtn = isMyPost ? `
                <button class="ml-auto text-gray-300 hover:text-red-400 p-1" onclick="event.stopPropagation(); window.deletePost('${post.id}')">
                    <i class="fa-solid fa-trash-can"></i>
                </button>` : '';
            
            return `
                <div class="p-4 ${isThreadMain ? 'bg-emerald-50/30' : 'bg-white'}" id="post-${post.id}" onclick="${!isThreadMain ? `window.openThread('${post.id}')` : ''}">
                    <div class="flex gap-3">
                        <div class="w-10 h-10 bg-gray-100 rounded-xl shrink-0 overflow-hidden flex items-center justify-center text-gray-400" onclick="event.stopPropagation(); window.showProfile('${post.uid}')">
                            ${avatarHtml}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1 mb-0.5">
                                <span class="font-bold text-sm truncate">${post.userName}</span>
                                <span class="text-[10px] bg-white border border-gray-100 px-1.5 py-0.5 rounded text-gray-400 font-bold">${history}</span>
                                ${deleteBtn}
                            </div>
                            <p class="text-[15px] leading-relaxed text-gray-800 break-words">${post.text}</p>
                            <div class="flex gap-6 mt-3 text-gray-400 text-xs font-bold">
                                <div class="flex items-center gap-1.5" onclick="event.stopPropagation(); window.openPostModal('${post.id}', '${post.userName}')">
                                    <i class="fa-regular fa-comment"></i> <span>${state.posts.filter(p => p.parentId === post.id).length}</span>
                                </div>
                                <div class="flex items-center gap-1.5 ${(!state.isDemo && post.likes?.includes(state.user?.uid)) ? 'text-pink-500' : ''}" onclick="event.stopPropagation(); window.toggleLike('${post.id}')">
                                    <i class="${(!state.isDemo && post.likes?.includes(state.user?.uid)) ? 'fa-solid' : 'fa-regular'} fa-heart"></i> <span>${post.likes?.length || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderHomePosts = () => {
            const container = document.getElementById('home-posts');
            const rootPosts = state.posts.filter(p => !p.parentId);
            const html = rootPosts.map(p => renderPost(p)).join('');
            container.innerHTML = html || '<div class="p-10 text-center text-gray-300 font-bold">投稿がありません</div>';
        };

        const renderThread = (rootId, targetScrollId = null) => {
            const container = document.getElementById('thread-content');
            const rootPost = state.posts.find(p => p.id === rootId);
            if (!rootPost) {
                container.innerHTML = '<div class="p-10 text-center text-gray-400">この投稿は削除されました</div>';
                return;
            }
            state.currentThreadRootId = rootId;
            let html = renderPost(rootPost, true);
            html += `<div class="mt-2 space-y-0 divide-y divide-gray-50 border-t border-gray-100">`;
            html += renderTree(rootId);
            html += `</div>`;
            container.innerHTML = html;

            if (targetScrollId) {
                setTimeout(() => {
                    const el = document.getElementById(`post-${targetScrollId}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        };

        const renderTree = (parentId, depth = 0) => {
            const children = state.posts.filter(p => p.parentId === parentId).sort((a,b) => new Date(a.date) - new Date(b.date));
            return children.map(child => {
                if (state.userData.blocks?.includes(child.uid)) return '';
                const avatarHtml = child.userAvatar ? `<img src="${child.userAvatar}" class="avatar-img">` : `<i class="fa-solid fa-user"></i>`;
                const isMyPost = state.user && !state.isDemo && state.user.uid === child.uid;
                const deleteBtn = isMyPost ? `<button class="ml-auto text-gray-300 hover:text-red-400" onclick="event.stopPropagation(); window.deletePost('${child.id}')"><i class="fa-solid fa-trash-can"></i></button>` : '';

                return `
                    <div class="ml-${depth === 0 ? '4' : '6'} border-l-2 border-gray-100 pl-4 py-3" id="post-${child.id}">
                        <div class="flex items-start gap-2">
                            <div class="w-8 h-8 bg-gray-100 rounded-lg shrink-0 overflow-hidden flex items-center justify-center text-[10px] text-gray-400" onclick="window.showProfile('${child.uid}')">
                                ${avatarHtml}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-xs truncate">${child.userName}</span>
                                    ${deleteBtn}
                                </div>
                                <p class="text-sm text-gray-700 break-words mb-2">${child.text}</p>
                                <div class="flex gap-4 text-[10px] font-bold text-gray-400">
                                    <button onclick="window.openPostModal('${child.id}', '${child.userName}')"><i class="fa-solid fa-reply"></i> 返信</button>
                                    <button class="${(!state.isDemo && child.likes?.includes(state.user?.uid)) ? 'text-pink-500' : ''}" onclick="window.toggleLike('${child.id}')">
                                        <i class="fa-solid fa-heart"></i> ${child.likes?.length || 0}
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${renderTree(child.id, depth + 1)}
                    </div>
                `;
            }).join('');
        };

        const renderNotifications = () => {
            const container = document.getElementById('notif-list');
            if (state.notifications.length === 0) {
                container.innerHTML = '<div class="p-10 text-center text-gray-300 font-bold">通知はありません</div>';
                return;
            }
            container.innerHTML = state.notifications.map(n => `
                <div class="p-4 bg-white flex gap-3 items-start border-b border-gray-50 active:bg-gray-50 transition" onclick="window.handleNotificationClick('${n.postId}', '${n.id}')">
                    <div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center shrink-0 text-xs">
                        <i class="fa-solid ${n.type === 'like' ? 'fa-heart text-pink-500' : 'fa-comment'}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm"><b>${n.fromName}</b>さんがあなたの投稿に${n.type === 'like' ? 'いいねしました' : '返信しました'}</p>
                        <p class="text-[10px] text-gray-400 mt-1">${new Date(n.date).toLocaleString()}</p>
                    </div>
                </div>
            `).join('');
        };

        const renderProfilePosts = (uid) => {
            const container = document.getElementById('prof-posts');
            const userPosts = state.posts.filter(p => p.uid === uid).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (userPosts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8 text-sm">投稿はまだありません</p>';
                return;
            }
            container.innerHTML = userPosts.map(p => renderPost(p)).join('');
        };

        // --- EXPOSED ACTIONS ---
        window.openPostModal = (pid = null, name = '') => {
            if (state.isDemo) return showToast('ログインすると投稿できます');
            state.replyTarget = pid;
            const info = document.getElementById('reply-target-info');
            if (pid) {
                info.classList.remove('hidden');
                info.querySelector('span').innerText = name;
            } else {
                info.classList.add('hidden');
            }
            // 履歴に追加してから表示
            history.pushState({ overlay: 'modal-overlay' }, '', '');
            document.getElementById('modal-overlay').classList.add('active');
            document.getElementById('modal-textarea').focus();
        };

        window.openThread = (postId) => {
            let current = state.posts.find(p => p.id === postId);
            let rootId = postId;
            while (current && current.parentId) {
                rootId = current.parentId;
                current = state.posts.find(p => p.id === rootId);
            }
            renderThread(rootId, postId);
            // 履歴に追加してから表示
            history.pushState({ overlay: 'thread-overlay' }, '', '');
            document.getElementById('thread-overlay').classList.add('active');
        };

        window.handleNotificationClick = async (postId, notifId) => {
            window.openThread(postId);
        };

        window.showProfile = async (uid) => {
            state.currentViewUid = uid;
            const isMe = state.user && uid === state.user.uid;
            document.getElementById('profile-actions').style.display = isMe ? 'none' : 'block';

            const snap = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'settings', 'profile'));
            const data = snap.exists() ? snap.data() : { name: "Unknown", bio: "まだ設定がありません", avatar: null, date: new Date().toISOString() };
            
            document.getElementById('prof-name').innerText = data.name;
            document.getElementById('prof-bio').innerText = data.bio;
            document.getElementById('prof-smoke-history').innerText = getSmokeHistory(data.date);
            document.getElementById('prof-avatar').innerHTML = data.avatar ? `<img src="${data.avatar}" class="avatar-img">` : `<i class="fa-solid fa-user"></i>`;
            
            const isBlocked = state.userData.blocks?.includes(uid);
            const btn = document.getElementById('btn-block-user');
            btn.innerHTML = isBlocked ? `<i class="fa-solid fa-user-check"></i> ブロックを解除` : `<i class="fa-solid fa-ban"></i> このユーザーをブロック`;
            btn.onclick = () => isBlocked ? window.unblockUser(uid) : window.blockUser(uid);

            renderProfilePosts(uid);
            // 履歴に追加してから表示
            history.pushState({ overlay: 'profile-overlay' }, '', '');
            document.getElementById('profile-overlay').classList.add('active');
        };

        window.blockUser = async (uid) => {
            if (state.isDemo) return showToast('ログインが必要です');
            if (confirm('このユーザーをブロックしますか？\n投稿が表示されなくなります。')) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'profile'), {
                    blocks: arrayUnion(uid)
                });
                showToast('ブロックしました');
                history.back();
            }
        };

        window.unblockUser = async (uid) => {
            if (state.isDemo) return;
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'profile'), {
                blocks: arrayRemove(uid)
            });
            showToast('ブロックを解除しました');
            if (document.getElementById('profile-overlay').classList.contains('active')) {
                window.showProfile(uid);
                renderProfilePosts(uid);
            }
        };

        window.toggleLike = async (postId) => {
            if (state.isDemo) return showToast('ログインすると「いいね」できます');
            const post = state.posts.find(p => p.id === postId);
            if (!post) return;

            const uid = state.user.uid;
            const isLiked = post.likes?.includes(uid);
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);

            await updateDoc(postRef, {
                likes: isLiked ? arrayRemove(uid) : arrayUnion(uid)
            });

            if (!isLiked && post.uid !== uid) {
                await addDoc(collection(db, 'artifacts', appId, 'users', post.uid, 'notifications'), {
                    type: 'like',
                    fromId: uid,
                    fromName: state.userData.name,
                    postId: postId,
                    date: new Date().toISOString()
                });
            }
        };

        window.deletePost = async (postId) => {
            if (!confirm('投稿を削除しますか？')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId));
            showToast('削除しました');
        };

        // --- LISTENERS ---
        window.addEventListener('popstate', (event) => {
            const overlays = ['modal-overlay', 'thread-overlay', 'profile-overlay'];
            overlays.forEach(id => {
                const el = document.getElementById(id);
                if (el.classList.contains('active')) {
                    el.classList.remove('active');
                    if (id === 'thread-overlay') state.currentThreadRootId = null;
                    if (id === 'profile-overlay') state.currentViewUid = null;
                }
            });
        });

        document.getElementById('btn-show-login').onclick = () => {
            state.authMode = 'login';
            document.getElementById('auth-action-text').innerText = 'ログイン';
            document.getElementById('gateway-buttons').style.display = 'none';
            document.getElementById('auth-form').classList.remove('hidden');
        };

        document.getElementById('btn-back-to-gateway').onclick = () => {
            document.getElementById('gateway-buttons').style.display = 'block';
            document.getElementById('auth-form').classList.add('hidden');
        };

        document.getElementById('btn-toggle-auth').onclick = () => {
            state.authMode = state.authMode === 'login' ? 'signup' : 'login';
            document.getElementById('auth-action-text').innerText = state.authMode === 'login' ? 'ログイン' : '新規登録';
            document.getElementById('btn-toggle-auth').innerText = state.authMode === 'login' ? 'アカウントを新規作成する' : '既にアカウントをお持ちの方';
        };

        document.getElementById('btn-execute-auth').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || !password) return showToast('入力してください');
            
            toggleUI('loading');
            try {
                if (state.authMode === 'signup') {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, 'artifacts', appId, 'users', res.user.uid, 'settings', 'profile'), state.userData);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (e) {
                showToast('エラー: ' + e.message);
                toggleUI('auth');
            }
        };

        document.getElementById('btn-guest-login').onclick = async () => {
            toggleUI('loading');
            await signInAnonymously(auth);
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        document.getElementById('btn-save-settings').onclick = async () => {
            if (state.isDemo) return showToast('デモモードでは保存できません');
            const data = {
                name: document.getElementById('cfg-name').value,
                bio: document.getElementById('cfg-bio').value,
                // input値はローカル時間なので、new Date()でUTCのISOStringに戻して保存する
                date: new Date(document.getElementById('cfg-date').value).toISOString(),
                sticks: parseInt(document.getElementById('cfg-sticks').value) || 20,
                price: parseInt(document.getElementById('cfg-price').value) || 600,
                // 編集中（state.editingAvatar）があればそれを使用し、なければ元のデータを使用
                avatar: state.editingAvatar || state.userData.avatar
            };
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'profile'), data);
            
            // 保存完了後、編集状態をクリア
            state.editingAvatar = null;
            showToast('保存しました');
        };

        document.getElementById('cfg-avatar-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                // state.userData.avatarは直接書き換えず、一時変数に保存
                state.editingAvatar = ev.target.result;
                document.getElementById('cfg-avatar-display').innerHTML = `<img src="${ev.target.result}" class="avatar-img">`;
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('btn-submit-post').onclick = async () => {
            const text = document.getElementById('modal-textarea').value.trim();
            if (!text) return;
            
            const post = {
                uid: state.user.uid,
                userName: state.userData.name,
                userAvatar: state.userData.avatar,
                userDate: state.userData.date,
                text: text,
                date: new Date().toISOString(),
                likes: [],
                parentId: state.replyTarget
            };

            const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), post);

            if (state.replyTarget) {
                const parent = state.posts.find(p => p.id === state.replyTarget);
                if (parent && parent.uid !== state.user.uid) {
                    await addDoc(collection(db, 'artifacts', appId, 'users', parent.uid, 'notifications'), {
                        type: 'reply',
                        fromId: state.user.uid,
                        fromName: state.userData.name,
                        postId: docRef.id,
                        date: new Date().toISOString()
                    });
                }
            }

            document.getElementById('modal-textarea').value = '';
            history.back();
            showToast('送信しました');
        };

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                // 画面切り替え時に編集中のアバターをリセット
                state.editingAvatar = null;
                // 設定画面を開くときはDBの値でフォームを再同期（リセット効果）
                if (btn.dataset.view === 'setting') syncSettingsUI();

                const view = btn.dataset.view;
                document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-emerald-600', 'text-gray-400'));
                btn.classList.replace('text-gray-400', 'text-emerald-600');
            };
        });

        document.getElementById('header-logo-area').onclick = () => {
            const homeBtn = document.querySelector('[data-view="home"]');
            homeBtn.click();
            const homeView = document.getElementById('view-home');
            homeView.scrollTo({ top: 0, behavior: 'smooth' });
        };

        ['modal-overlay', 'thread-overlay', 'profile-overlay'].forEach(id => {
            document.getElementById(id).onclick = (e) => {
                if (e.target.id === id) {
                    history.back();
                }
            };
        });

        document.getElementById('fab').onclick = () => window.openPostModal();
        document.getElementById('btn-close-modal').onclick = () => history.back();
        document.getElementById('btn-close-thread').onclick = () => history.back();
        document.getElementById('btn-close-profile').onclick = () => history.back();
        
        document.getElementById('btn-clear-notif').onclick = async () => {
            if (state.isDemo) return;
            const batch = writeBatch(db);
            const snaps = await getDocs(collection(db, 'artifacts', appId, 'users', state.user.uid, 'notifications'));
            snaps.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

    </script>
</body>
</html>